# Backend Documentation

## Overview
This project uses **Supabase** as the backend-as-a-service (BaaS). Supabase provides the PostgreSQL database, Authentication, Realtime subscriptions, and Storage.

## Architecture
- **Frontend**: Flutter (Mobile App)
- **Backend Services**: Supabase (Cloud hosted)
- **Authentication**: Supabase Auth (Native + Social Providers)
- **Database**: PostgreSQL
- **Asset Storage**: Supabase Storage

## Database Schema

### Tables

1.  **`products`**
    *   `id`: UUID (PK)
    *   `name`: Text
    *   `image_url`: Text
    *   `current_price`: Numeric
    *   `market_price`: Numeric
    *   `stock`: Integer
    *   `category`: Text
    *   *RLS*: Public Read. Write restricted to Service Role.

2.  **`orders`**
    *   `id`: UUID (PK)
    *   `user_id`: UUID (FK to `auth.users`)
    *   `items`: JSONB (Snapshot of cart)
    *   `total_amount`: Numeric
    *   `status`: Text (pending, confirmed, delivered, cancelled)
    *   *RLS*: Users can Select/Insert their own orders.

3.  **`profiles`**
    *   `id`: UUID (PK, FK to `auth.users`, 1:1 relationship)
    *   `first_name`, `last_name`: Text
    *   `phone`: Text
    *   *RLS*: Public Read. Users can Update their own.

4.  **`addresses`**
    *   `id`: UUID (PK)
    *   `user_id`: UUID (FK to `auth.users`)
    *   `street`, `city`, `zip_code`: Text
    *   `is_default`: Boolean
    *   *RLS*: Private. Users can CRUD their own addresses.

## Security (Row Level Security)
We use a "Secure by Default" approach. All tables have RLS enabled.
- **Public Data**: `products`, `profiles` (Read-only).
- **User Data**: `orders`, `addresses` (Owner-only access).

> **Important**: Never use the `service_role` key in the Flutter app. Always use the `anon` key.

## Common Mistakes to Avoid (Checklist)
Based on our auditing guide:
- [ ] **Validation**: Do not trust client input. Database `CHECK` constraints are your last line of defense.
- [ ] **Error Handling**: The app should handle connectivity errors gracefully (e.g., "offline" mode).
- [ ] **Environment Variables**: Verify `.env` is invalid in your git repo.
- [ ] **Blind Trust**: Always review code generated by AI before running it against the production database.

## Deployment
The backend is serverless. To deploy changes:
1.  Run SQL migration scripts in the Supabase SQL Editor.
2.  Update Flutter `lib/core/init/app_providers.dart` (or wherever env vars are loaded) if keys change.

## Troubleshooting
**Issue**: "Permission denied" errors.
**Fix**: Check RLS policies. Ensure the user is authenticated (`auth.uid()` is not null).

**Issue**: Images not loading.
**Fix**: Check Storage Bucket "Public" setting.
